<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WebSocket Chat</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg: #0f1115; --panel: #151922; --panel-2:#1b2130; --text: #e6e6e6;
      --muted:#9aa4b2; --brand:#7c9cff; --brand-2:#9fb3ff; --danger:#ff6b6b;
      --ok:#2ecc71; --border: #273043; --bubble-me:#2441ff1f; --bubble-other:#ffffff0f;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f5f7fb; --panel:#ffffff; --panel-2:#ffffff; --text:#1c2430; --muted:#637085;
        --brand:#365cff; --brand-2:#6780ff; --border:#e6ebf2; --bubble-me:#365cff12; --bubble-other:#00000006;
        --shadow: 0 10px 30px rgba(0,0,0,.08);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,var(--bg),var(--panel-2));
      color:var(--text); font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;
      display:grid; place-items:center; padding:16px;
    }
    .app{width:min(900px,100%); height:min(80vh,900px); display:flex; flex-direction:column;
      background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); overflow:hidden;}
    .header{display:flex; align-items:center; gap:12px; padding:14px 16px; border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,transparent,rgba(0,0,0,.03));}
    .dot{width:10px;height:10px;border-radius:50%;}
    .dot.ok{background:var(--ok); box-shadow:0 0 0 4px color-mix(in srgb,var(--ok) 25%, transparent)}
    .dot.bad{background:var(--danger); box-shadow:0 0 0 4px color-mix(in srgb,var(--danger) 25%, transparent)}
    .title{font-weight:600}
    .sub{color:var(--muted); font-size:13px}
    .messages{flex:1; overflow:auto; padding:18px; display:flex; flex-direction:column; gap:10px;
      background:
        radial-gradient(1200px 400px at 120% -20%, color-mix(in srgb,var(--brand) 6%, transparent), transparent),
        radial-gradient(1000px 300px at -10% 110%, color-mix(in srgb,var(--brand-2) 7%, transparent), transparent);}
    .msg{max-width:76%; padding:10px 12px; border-radius:14px; position:relative; border:1px solid var(--border);
      backdrop-filter:saturate(140%) blur(0px); word-wrap:break-word; white-space:pre-wrap;}
    .msg.me{align-self:flex-end; background:var(--bubble-me);}
    .msg.other{align-self:flex-start; background:var(--bubble-other);}
    .meta{display:flex; gap:8px; align-items:center; margin-top:6px; font-size:12px; color:var(--muted)}
    .author{font-weight:600}
    .ts{font-variant-numeric:tabular-nums}
    .composer{padding:12px; border-top:1px solid var(--border); background:var(--panel-2); display:flex; gap:10px; align-items:center;}
    .input{flex:1; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:transparent; color:var(--text); outline:none;}
    .input:focus{border-color:var(--brand); box-shadow:0 0 0 4px color-mix(in srgb,var(--brand) 20%, transparent)}
    .btn{padding:12px 16px; border-radius:12px; border:1px solid var(--brand); cursor:pointer;
      background:linear-gradient(180deg,var(--brand-2),var(--brand)); color:white; font-weight:600; transition:transform .05s ease; user-select:none;}
    .btn:disabled{opacity:.5; cursor:not-allowed; filter:grayscale(.3)}
    .btn:active{transform:translateY(1px)}
    .messages::-webkit-scrollbar{height:10px;width:10px}
    .messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:10px}
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div id="statusDot" class="dot bad"></div>
      <div>
        <div class="title">WebSocket Chat — <span id="meName">…</span></div>
        <div id="statusText" class="sub">Оффлайн</div>
      </div>
    </div>

    <div id="messages" class="messages"></div>

    <form id="form" class="composer" autocomplete="off">
      <input id="messageText" class="input" type="text" placeholder="Напишите сообщение…" />
      <button id="sendBtn" class="btn" disabled>Отправить ↵</button>
    </form>
  </div>

  <script>
    // Получаем имя из Telegram Web App (fallback на Guest-XXXX)
    function resolveName() {
      try {
        const tg = window.Telegram?.WebApp;
        const u = tg?.initDataUnsafe?.user;
        if (u) {
          const fn = [u.first_name, u.last_name].filter(Boolean).join(' ');
          return fn || u.username || `User${u.id}`;
        }
      } catch (_) {}
      const cached = localStorage.getItem('guest_name');
      if (cached) return cached;
      const name = 'Guest-' + Math.random().toString(36).slice(2, 6).toUpperCase();
      localStorage.setItem('guest_name', name);
      return name;
    }

    // Автоматически расширим мини-апп, если в Telegram
    try { window.Telegram?.WebApp?.expand(); } catch (_) {}

    const myName = resolveName();
    document.getElementById('meName').textContent = myName;

    // URL WS: текущий хост + имя в query
    const DEFAULT_WS =
      (location.protocol === 'https:' ? 'wss://' : 'ws://') +
      location.host + '/ws?name=' + encodeURIComponent(myName);

    const ui = {
      list: document.getElementById('messages'),
      input: document.getElementById('messageText'),
      form: document.getElementById('form'),
      send: document.getElementById('sendBtn'),
      dot: document.getElementById('statusDot'),
      status: document.getElementById('statusText')
    };

    let ws = null;
    let reconnectTimer = null;

    function setStatus(online, text){
      ui.dot.className = 'dot ' + (online ? 'ok' : 'bad');
      ui.status.textContent = text || (online ? 'Онлайн' : 'Оффлайн');
      ui.send.disabled = !online;
    }

    function bubble(text, who='other', author=null){
      const wrap = document.createElement('div');
      wrap.className = `msg ${who}`;
      wrap.textContent = text;

      const meta = document.createElement('div');
      meta.className = 'meta';
      if (author) {
        const a = document.createElement('span');
        a.className = 'author';
        a.textContent = author;
        meta.appendChild(a);
      }
      const ts = document.createElement('span');
      ts.className = 'ts';
      ts.textContent = new Date().toLocaleTimeString();
      meta.appendChild(ts);

      wrap.appendChild(meta);
      ui.list.appendChild(wrap);
      ui.list.scrollTop = ui.list.scrollHeight;
    }

    function connect(url = DEFAULT_WS){
      if (ws) { try { ws.close(); } catch(e){} }
      ws = new WebSocket(url);

      ws.addEventListener('open', () => {
        setStatus(true, 'Подключено');
        if (reconnectTimer) { clearTimeout(reconnectTimer); reconnectTimer = null; }
      });

      ws.addEventListener('message', (evt) => {
        // ожидаем формат "Имя: текст"
        const ix = evt.data.indexOf(':');
        if (ix > -1) {
          const author = evt.data.slice(0, ix).trim();
          const text = evt.data.slice(ix + 1).trim();
          bubble(text, author === myName ? 'me' : 'other', author);
        } else {
          bubble(evt.data, 'other');
        }
      });

      ws.addEventListener('close', () => {
        setStatus(false, 'Отключено — пробуем переподключиться…');
        reconnectTimer = setTimeout(() => connect(url), 1500);
      });

      ws.addEventListener('error', () => {
        setStatus(false, 'Ошибка соединения');
      });
    }

    ui.form.addEventListener('submit', (e) => {
      e.preventDefault();
      const text = ui.input.value.trim();
      if (!text || !ws || ws.readyState !== 1) return;
      ws.send(text);
      bubble(text, 'me', myName); // локально рисуем своё сообщение
      ui.input.value = '';
      ui.input.focus();
    });

    ui.input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        ui.form.requestSubmit();
      }
    });

    connect();
  </script>
</body>
</html>
